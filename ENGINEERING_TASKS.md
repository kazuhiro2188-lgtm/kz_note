# kz_note 工程表

## 概要

NoteCard の各ボタン（チャットで深掘り、図解を開く、AIマインドマップ、検索に登録）、チャットの実装、セキュリティ・ログインの残タスクを整理した工程表です。

---

## 1. NoteCard の各ボタン

| 項目 | 現状 | 残タスク | 優先度 |
|------|------|----------|--------|
| **チャットで深掘り** | `/chat?note=xxx` へのリンク | チャットページで `note` パラメータを読み取り、そのメモをコンテキストにしたチャットを開始する処理が未実装 | 高 |
| **図解を開く** | 実装済み | なし | - |
| **AIマインドマップ** | 実装済み | なし | - |
| **検索に登録** | 実装済み | なし | - |

### 1-1. チャットで深掘り（詳細）

| 工程 | 内容 | 担当 |
|------|------|------|
| 1-1-1 | `chat/page.tsx` で `searchParams.note` を取得 | フロント |
| 1-1-2 | `KnowledgeChat` に `initialNoteId?: string` を渡す | フロント |
| 1-1-3 | チャット API に `noteId` を指定可能にする | バックエンド |
| 1-1-4 | `noteId` 指定時はそのメモの内容を優先コンテキストにした RAG 応答 | バックエンド |
| 1-1-5 | プレースホルダーに「このメモについて質問...」などコンテキスト表示 | フロント |

---

## 2. チャットの実装

| 工程 | 内容 | 現状 | 優先度 |
|------|------|------|--------|
| 2-1 | ノート指定時のコンテキストチャット | 未実装 | 高 |
| 2-2 | チャット UI のデザイン統一（アプリテーマに合わせる） | ✅ 完了 | - |
| 2-3 | チャット履歴の永続化 | 実装済み | - |
| 2-4 | RAG によるメモ参照 | 実装済み | - |
| 2-5 | エラーハンドリング・UX | ✅ 完了 | - |

---

## 3. セキュリティ・ログイン

| 工程 | 内容 | 現状 | 優先度 |
|------|------|------|--------|
| 3-1 | 認証必須ルートの保護 | 未実装（匿名認証で全アクセス） | 高 |
| 3-2 | ログイン必須ページへのリダイレクト | 未実装 | 高 |
| 3-3 | 匿名ユーザーのアカウントアップグレード | 未実装 | 中 |
| 3-4 | メール認証の有効化 | 実装済み | - |
| 3-5 | Google OAuth | 削除済み | - |
| 3-6 | API ルートの認証チェック | 一部実装済み | - |

### 3-1. 認証・セキュリティの詳細

| 工程 | 内容 | 備考 |
|------|------|------|
| 3-1-1 | `middleware.ts` で `/(app)/*` を認証必須にする | 未認証なら `/login` へリダイレクト |
| 3-1-2 | 匿名認証を許可するかどうか | 現状維持なら「匿名 or ログイン」のどちらかで OK |
| 3-1-3 | ログイン後リダイレクト先の指定 | `?redirect=/chat` など |
| 3-1-4 | `AnonymousAuth` の扱い | ログイン必須にするなら削除または条件分岐 |
| 3-1-5 | セッション有効期限・リフレッシュ | Supabase のデフォルト |
| 3-1-6 | CSRF 対策 | Next.js の Server Actions はデフォルトで対応 |
| 3-1-7 | 環境変数・機密情報の管理 | `.env.local` を git に含めない（確認済み） |

---

## 4. 優先順位付き実施順序

### Phase A: チャットで深掘り（1-2 日）✅ 完了

1. ✅ チャット API に `noteId` パラメータ追加
2. ✅ `noteId` 指定時はそのメモの内容を優先コンテキストにした RAG
3. ✅ チャットページで `note` クエリを読み取り、`KnowledgeChat` に渡す
4. ✅ プレースホルダー・UI の調整（フォーカスバッジ、解除ボタン）

### Phase B: セキュリティ・ログイン（1-2 日）✅ 完了

1. ✅ 認証ポリシー: 匿名認証を維持（現状どおり）
2. ✅ `middleware`: セッション検証・コメント追加
3. - 未認証時の `/login` リダイレクト（匿名認証のため未実装）
4. ✅ ログイン後のリダイレクト先（`redirect` パラメータ）の実装

### Phase C: チャット UI の統一（0.5 日）✅ 完了

1. ✅ チャットコンポーネントのスタイルをアプリテーマに合わせる（amber/zinc → CSS 変数）

### Phase D: エラーハンドリング・UX ✅ 完了

1. ✅ KnowledgeChat: ユーザー向けエラーメッセージ変換、ネットワークエラー文言
2. ✅ TopicFeed: 再試行ボタン、アプリテーマのエラー表示、日本語メッセージ
3. ✅ NoteCard: 図解・マインドマップ・検索登録のエラー表示
4. ✅ SemanticSearchWidget: 検索失敗時のエラー表示
5. ✅ embed API: try-catch でエラーレスポンス返却

---

## 5. 参考ファイル

| 機能 | 対象ファイル |
|------|--------------|
| チャットで深掘り | `components/NoteCard.tsx` (L184-186), `app/(app)/chat/page.tsx`, `components/KnowledgeChat.tsx`, `app/api/ai/chat/route.ts` |
| 図解・マインドマップ・検索登録 | `components/NoteCard.tsx`, `app/api/ai/flowchart/route.ts`, `app/api/ai/mindmap/route.ts`, `app/api/ai/embed/route.ts` |
| 認証・ログイン | `middleware.ts`, `app/(app)/layout.tsx`, `components/AnonymousAuth.tsx`, `app/login/page.tsx`, `app/auth/callback/route.ts` |

---

## 6. 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-14 | 初版作成 |
